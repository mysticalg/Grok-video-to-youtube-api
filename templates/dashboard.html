<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Grok Video Studio - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body>
    <main class="container">
      <header class="row spread">
        <h1>Welcome, {{ username }}</h1>
        <a href="{{ url_for('logout') }}">Logout</a>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% endwith %}

      <section class="card">
        <h2>Settings</h2>
        <form method="post">
          <label>Generation mode
            <select name="generation_mode">
              <option value="api" {% if generation_mode == 'api' %}selected{% endif %}>Grok API</option>
              <option value="web" {% if generation_mode == 'web' %}selected{% endif %}>Web automation (manual login)</option>
            </select>
          </label>
          <label>Grok API Key
            <input name="grok_api_key" value="{{ grok_api_key }}" placeholder="xai-..." />
          </label>
          <div class="row">
            <label>Chat model <input name="chat_model" value="{{ chat_model }}" /></label>
            <label>Video model <input name="image_model" value="{{ image_model }}" /></label>
          </div>
          <label>YouTube OAuth Client Secret JSON
            <textarea name="youtube_client_secret_json" rows="6" placeholder='{"installed":{...}}'>{{ youtube_client_secret_json }}</textarea>
          </label>
          <button type="submit">Save Settings</button>
        </form>

        <form method="post" action="{{ url_for('web_login') }}" class="inner-form">
          <p><strong>Web mode setup:</strong> click to open a browser window, login manually, and wait until Imagine prompt box appears.</p>
          <label>Manual login timeout (seconds)
            <input type="number" name="timeout_s" min="60" max="900" value="300">
          </label>
          <button type="submit" class="alt">Start Manual Web Login Capture</button>
        </form>
      </section>

      <section class="card">
        <h2>Batch automation</h2>
        <form method="post" action="{{ url_for('generate') }}" id="generate-form">
          <input type="hidden" name="generation_mode" value="{{ generation_mode }}">
          <label>Concept (used in API mode, optional in web mode)
            <textarea name="concept" rows="3" placeholder="Cinematic drone flythrough over a futuristic rainforest city at sunrise"></textarea>
          </label>
          <label>Manual prompt (used directly in web mode)
            <textarea name="manual_prompt" rows="4" placeholder="A surreal 10s sequence of chrome koi fish swimming through neon rain"></textarea>
          </label>
          <label>How many videos to generate (1-10)
            <input type="number" name="count" value="1" min="1" max="10" />
          </label>
          <button type="submit" id="generate-btn">Generate Videos</button>
          <p id="generate-status" aria-live="polite"></p>
        </form>
      </section>

      <section class="card">
        <h2>Preview + individual upload controls</h2>
        <div class="video-grid">
          {% for video in videos %}
          <article class="video-card">
            <div class="row spread">
              <small>{{ video.resolution }}</small>
              {% if video.youtube_video_id %}<small>Uploaded: {{ video.youtube_video_id }}</small>{% endif %}
            </div>
            <video controls preload="metadata" src="{{ url_for('stream_video', video_id=video.id) }}"></video>
            <p><strong>Title:</strong> {{ video.title }}</p>
            <p><strong>Prompt:</strong> {{ video.prompt }}</p>
            <div class="row wrap"><a href="{{ url_for('download', video_id=video.id) }}">Download</a></div>

            <form method="post" action="{{ url_for('youtube_upload', video_id=video.id) }}" class="inner-form">
              <label>Title <input name="title" value="{{ video.title }}"></label>
              <label>Description <textarea name="description" rows="3">{{ video.description }}</textarea></label>
              <label>Hashtags <input name="hashtags" value="{{ video.hashtags }}"></label>
              <button type="submit">Upload this video to YouTube</button>
            </form>

            <form method="post" action="{{ url_for('generate_from_last_frame', video_id=video.id) }}" class="inner-form">
              <button type="submit" class="alt">Generate follow-up from last frame (API)</button>
            </form>
          </article>
          {% endfor %}
          {% if not videos %}
          <p>No generated videos yet.</p>
          {% endif %}
        </div>
      </section>

      <section class="card">
        <h2>Stitch selected videos</h2>
        <form method="post" action="{{ url_for('stitch') }}">
          <div class="stitch-list">
            {% for video in videos %}
            <label><input type="checkbox" name="video_ids" value="{{ video.id }}"> {{ video.title }}</label>
            {% endfor %}
          </div>
          <button type="submit">Stitch Selected</button>
        </form>
      </section>
    </main>
    <script>
      (() => {
        const form = document.getElementById('generate-form');
        const button = document.getElementById('generate-btn');
        const status = document.getElementById('generate-status');
        if (!form || !button || !status) {
          return;
        }

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          button.disabled = true;
          status.textContent = 'Generating videos...';

          try {
            const response = await fetch(form.action, {
              method: 'POST',
              body: new FormData(form),
              headers: {
                'X-Requested-With': 'fetch',
              },
            });

            if (!response.ok) {
              throw new Error(`Request failed (${response.status})`);
            }

            status.textContent = 'Generation request sent. Refresh when you want to load new videos.';
          } catch (error) {
            status.textContent = `Generation failed: ${error}`;
          } finally {
            button.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>
